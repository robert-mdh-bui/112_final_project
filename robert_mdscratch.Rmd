---
title: "robert_scratchmd"
author: "bobbytables"
date: "12/4/2019"
output: html_document
---

```{r}
library(tidyverse)
library(tidyr)
library(fst)
library(plotly)
library(lubridate)
library(ggcorrplot)
```


```{r}
rm(list=setdiff(ls(), c()))
gc()


data18 <- read_fst("data18-fixed.fst") %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "9E", "DL")) %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "VX", "AS")) %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "MQ", "AA")) %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "OH", "AA"))
airports <- read_fst("airport_data.fst")
cols <- c("AA"="#36ace2",
          "AS"="#488509",
          "B6"="#16339f",
          "DL"="#e01e32",
          "EV"="#27446a",
          "F9"="#176642",
          "G4"="#00569c",
          "HA"="#ca0f88",
          "NK"="#fcec03",
          "OO"="steelblue",
          "UA"="#1530a2",
          "WN"="#f9a817",
          "YV"="#aaa9ad",
          "YX"="black")
```

# Correlation Matrix of Numerical Variables (not enough data to be helpful)

```{r}
corr18 <- data18 %>% 
  mutate(
    DATE = as.numeric(ymd(FL_DATE) - ymd(20171231)),
    DESTINATION_AIRPORT = DEST_AIRPORT_ID - 10000
  ) %>% 
  select(DATE,DESTINATION_AIRPORT,CRS_DEP_TIME,DISTANCE,AIR_TIME,DEP_DELAY) 

corr <- cor(corr18,use = "complete.obs")
pmat <- cor_pmat(corr18, use = "complete.obs")
```


```{r fig.height=6, fig.width=6}
ggcorrplot(corr, hc.order = TRUE, p.mat = pmat, lab =T)+
    #theme_minimal()+
    scale_fill_viridis_c()
```


# Causes of Delay by day of the week

```{r fig.height=6, fig.width=6}
choice18 %>% 
  mutate(
    wkday = wday(FL_DATE,label = T)
  ) %>% 
  group_by(wkday,type) %>% 
  summarise(
    #Actual = mean(DEP_DELAY, na.rm = T),
    Carrier = mean(CARRIER_DELAY, na.rm = T),
    Weather = mean(WEATHER_DELAY, na.rm = T),
    NAS = mean(NAS_DELAY, na.rm = T),
    `Late Aircraft` = mean(LATE_AIRCRAFT_DELAY, na.rm = T),
    Security = mean(SECURITY_DELAY, na.rm = T)
  ) %>% 
  pivot_longer(
    cols = -c(wkday,type),
    names_to = "Cause",
    values_to = "Minutes"
  ) %>% 
  ggplot()+
  geom_col(aes(x=wkday,y=Minutes,fill=Cause), position="stack")+
  theme_minimal()+
  scale_fill_viridis_d()+
  labs(
    x = "Day of the Week",
    y = "Average Delayed Minutes (NA Removed)"
  )+
  facet_grid(Cause ~ type)+
  coord_flip()

```

# Causes of Delay by Airline

```{r fig.height=6, fig.width=6}
choice18 %>% 
  group_by(OP_UNIQUE_CARRIER,type) %>% 
  summarise(
    Carrier = mean(CARRIER_DELAY, na.rm = T),
    `Late Aircraft` = mean(LATE_AIRCRAFT_DELAY, na.rm = T)
  ) %>% 
  pivot_longer(
    cols = -c(OP_UNIQUE_CARRIER,type),
    names_to = "Cause",
    values_to = "Minutes"
  ) %>% 
  ggplot()+
  geom_col(aes(x=OP_UNIQUE_CARRIER,y=Minutes,fill=OP_UNIQUE_CARRIER))+
  theme_minimal()+
  scale_fill_manual(values = cols)+
  labs(
    x = "Airline",
    y = "Average Delayed Minutes (NA Removed)"
  )+  
  facet_grid(type ~ Cause) +coord_flip()

  
```

# Where can you go?

```{r}
library(tidyverse)
library(tidyr)
library(fst)
library(plotly)
library(lubridate)

rm(list=setdiff(ls(), c()))
gc()


data18 <- read_fst("data18-fixed.fst") %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "9E", "DL")) %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "VX", "AS")) %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "MQ", "AA")) %>% 
  mutate(OP_UNIQUE_CARRIER = replace(OP_UNIQUE_CARRIER, OP_UNIQUE_CARRIER == "OH", "AA"))
airports <- read_fst("airport_data.fst")
cols <- c("AA"="#36ace2",
          "AS"="#488509",
          "B6"="#16339f",
          "DL"="#e01e32",
          "EV"="#27446a",
          "F9"="#176642",
          "G4"="#00569c",
          "HA"="#ca0f88",
          "NK"="#fcec03",
          "OO"="steelblue",
          "UA"="#1530a2",
          "WN"="#f9a817",
          "YV"="#aaa9ad",
          "YX"="black")

choice <- "MSP"
typechoice <- "Departures"

sp <- airports %>% 
  filter(
    ORIGIN == choice
  )

choice18 <- data18 %>% 
  filter(
    ORIGIN_AIRPORT_ID == sp$ORIGIN_AIRPORT_ID | DEST_AIRPORT_ID == sp$ORIGIN_AIRPORT_ID
  ) %>% 
  mutate(
    type = ifelse(
      ORIGIN_AIRPORT_ID == sp$ORIGIN_AIRPORT_ID,
      "Departures",
      "Arrivals"
    )
  )

fltr18 <- choice18 %>% 
  filter(
    type == typechoice
  )

fltr18a <- read.csv(text="ORI_ID,DES_ID")
fltr18d <- read.csv(text="ORI_ID,DES_ID")

if (fltr18$type[1] == "Departures") {
  fltr18d <- fltr18 %>% 
    rename(
      ORI_ID = ORIGIN_AIRPORT_ID,
      DES_ID = DEST_AIRPORT_ID
    ) %>% 
    select(V1,FL_DATE,OP_UNIQUE_CARRIER,ORI_ID,DES_ID) %>% 
    group_by(ORI_ID,DES_ID,OP_UNIQUE_CARRIER) %>% 
    summarise(
      airline_n = n_distinct(V1)
    ) 
} else {
  fltr18a <- fltr18 %>% 
    rename(
      DES_ID = ORIGIN_AIRPORT_ID,
      ORI_ID = DEST_AIRPORT_ID
    ) %>% 
    select(V1,FL_DATE,OP_UNIQUE_CARRIER,ORI_ID,DES_ID) %>% 
    group_by(ORI_ID,DES_ID,OP_UNIQUE_CARRIER) %>% 
    summarise(
      airline_n = n_distinct(V1)
    ) 
}

fltr18m <- full_join(fltr18d,fltr18a)

rm(list=setdiff(ls(), c("fltr18m","airports","cols")))
gc()

fmax <- fltr18m %>% 
  group_by(DES_ID) %>% 
  summarise(
    max = max(airline_n)
  ) %>% 
  left_join(fltr18m, by = c("DES_ID"="DES_ID","max"="airline_n")) %>% 
  select(
    DES_ID, OP_UNIQUE_CARRIER
  )

fltr18g <- fltr18m %>% 
  group_by(ORI_ID,DES_ID) %>% 
  summarise(
    n = sum(airline_n)
  ) %>% 
  left_join(airports,
            by = c("ORI_ID" = "ORIGIN_AIRPORT_ID")) %>% 
  rename(ori_code = ORIGIN,
         ori_lat = lat,
         ori_lon = lon,
         ori_name = name) %>% 
  left_join(airports,
            by = c("DES_ID" = "ORIGIN_AIRPORT_ID")) %>% 
  rename(des_code = ORIGIN,
         des_lat = lat,
         des_lon = lon,
         des_name = name) %>% 
  left_join(fmax) %>% 
  rename(
    ori_id = ORI_ID,
    des_id = DES_ID,
    airline = OP_UNIQUE_CARRIER
  )

rm(list=setdiff(ls(), c("fltr18g","cols")))
gc()

geo <- list(
      #scope = "usa",
      projection = list(
      type = 'orthographic',
      rotation = list(lon = -100, lat = 40, roll = 0)
      ),
      showland = T,
      landcolor = 'transparent',
      countrycolor = 'transparent'
    )
    
p <- plot_geo() %>%
      add_segments(
        data = fltr18g, x = ~ori_lon, xend = ~des_lon,
        y = ~ori_lat, yend = ~des_lat,
        hoverinfo = "none",
        color = ~airline,
        colors = cols,
        alpha=.175#, size=I(linesize)
      ) %>% 
      add_markers(
        data = fltr18g, x = ~des_lon, y = ~des_lat, 
        text = ~paste("Airport:", des_code, "|",des_name, "<br>Airline with most flights:", airline), 
        hoverinfo = "text",
        size = ~n^2, 
        alpha=1,
        color = ~airline,
        colors = cols
      ) %>% 
  add_markers(
        data = fltr18g, x = ~ori_lon, y = ~ori_lat, 
        text = ~paste(ori_code, "|", ori_name), 
        hoverinfo = "text",
        size = I(10),
        symbol = I("star"),
        color = I("red")
      )

rm(list=setdiff(ls(), c("p","geo")))
gc()
    
ggplotly(p) %>% 
      layout(
        title = 'How connected is your airport, and which carriers?',
        geo = geo, showlegend = TRUE,
        plot_bgcolor='transparent',
        paper_bgcolor='transparent'
      )
```

